generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id             String          @id @default(cuid())
  username       String          @unique
  email          String          @unique
  passwordHash   String
  role           String          @default("USER") // USER or ADMIN
  avatar         String?
  bio            String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  favorites      Favorite[]
  playHistory    PlayHistory[]
  sessions       Session[]
  reviews        Review[]
  collections    Collection[]
  passwordResets PasswordReset[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model Game {
  id               String           @id @default(cuid())
  slug             String           @unique
  title            String
  shortDescription String
  longDescription  String
  thumbnail        String
  screenshots      String           @default("[]")
  tags             String           @default("[]")
  size             String           @default("mini")
  type             String           @default("web-embed")
  releaseStatus    String           @default("released")
  url              String
  platforms        String           @default("[]")
  developer        String?
  releaseDate      DateTime?
  version          String?
  featured         Boolean          @default(false)
  hidden           Boolean          @default(false)
  viewCount        Int              @default(0)
  playCount        Int              @default(0)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  favorites        Favorite[]
  playHistory      PlayHistory[]
  reviews          Review[]
  collections      CollectionGame[]

  @@index([hidden, featured, createdAt])
  @@index([hidden, createdAt])
  @@index([size])
  @@index([type])
  @@index([releaseStatus])
  @@index([viewCount])
  @@index([playCount])
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  gameId    String
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, gameId])
  @@index([userId, createdAt])
  @@index([gameId])
}

model PlayHistory {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  gameId     String
  game       Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  lastPlayed DateTime @default(now())

  @@unique([userId, gameId])
  @@index([userId, lastPlayed])
  @@index([gameId])
}

model Review {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  gameId    String
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  rating    Int      // 1-5 stars
  title     String?
  content   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, gameId])
  @@index([gameId, createdAt])
  @@index([userId])
}

model Collection {
  id          String           @id @default(cuid())
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  description String?
  isPublic    Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  games       CollectionGame[]

  @@index([userId, createdAt])
  @@index([isPublic, createdAt])
}

model CollectionGame {
  id           String     @id @default(cuid())
  collectionId String
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  gameId       String
  game         Game       @relation(fields: [gameId], references: [id], onDelete: Cascade)
  addedAt      DateTime   @default(now())

  @@unique([collectionId, gameId])
  @@index([collectionId, addedAt])
  @@index([gameId])
}

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model RateLimit {
  id         String   @id @default(cuid())
  identifier String   // IP address or user ID
  endpoint   String   // API endpoint being rate limited
  count      Int      @default(1)
  windowStart DateTime @default(now())

  @@unique([identifier, endpoint])
  @@index([identifier, endpoint, windowStart])
}
